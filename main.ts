/// <reference no-default-lib="true" />
/// <reference lib="dom" />
/// <reference lib="dom.iterable" />
/// <reference lib="dom.asynciterable" />
/// <reference lib="deno.ns" />

/**
 * Ğ¢Ğ¾Ñ‡ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ "Ğ¦Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ¾Ğ¹ ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ¸Ñ‚ĞµÑ‚"
 * 
 * ĞŸĞ¾Ñ€ÑĞ´Ğ¾Ğº Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:
 * 1. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
 * 2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº Ğ‘Ğ”
 * 3. Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹
 * 4. Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ (ĞµÑĞ»Ğ¸ Ğ±Ğ°Ğ·Ğ° Ğ¿ÑƒÑÑ‚Ğ°Ñ)
 * 5. Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ„Ğ¾Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ
 * 6. Ğ—Ğ°Ğ¿ÑƒÑĞº Fresh ÑĞµÑ€Ğ²ĞµÑ€Ğ°
 */

import '$std/dotenv/load.ts';

import { start } from '$fresh/server.ts';
import manifest from './fresh.gen.ts';
import config from './fresh.config.ts';
import { logger } from './src/utils/logger.ts';
import { testConnection, closePool, query } from './src/config/database.ts';
import { runMigrations } from './src/db/migrations.ts';
import { seedUniversities } from './src/db/seed.ts';
import { startUpdateWorker, stopUpdateWorker } from './src/workers/update.worker.ts';
import { loadEnv } from './src/config/env.ts';

/**
 * ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ğ°Ñ Ğ»Ğ¸ Ğ±Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
 */
async function checkDbEmpty(): Promise<boolean> {
  try {
    const result = await query<{ count: string }>('SELECT COUNT(*) as count FROM universities');
    return parseInt(result[0]?.count ?? '0', 10) === 0;
  } catch {
    return true;
  }
}

/**
 * Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
 */
async function main(): Promise<void> {
  const startTime = Date.now();
  
  logger.info('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  logger.info('â•‘     ğŸ“ Ğ¦Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ¾Ğ¹ ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ¸Ñ‚ĞµÑ‚ - Ğ—Ğ°Ğ¿ÑƒÑĞº      â•‘');
  logger.info('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  try {
    // 1. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
    logger.info('ğŸ“‹ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸...');
    const env = loadEnv();
    logger.info('ĞĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ:', { 
      DENO_ENV: env.DENO_ENV,
      PORT: env.PORT,
    });
    
    // 2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº Ğ‘Ğ”
    logger.info('ğŸ”Œ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...');
    const dbConnected = await testConnection();
    
    if (!dbConnected) {
      throw new Error('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…');
    }
    logger.info('âœ… Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ°');
    
    // 3. Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹
    logger.info('ğŸ“¦ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹...');
    const migrations = await runMigrations();
    logger.info('âœ… ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ñ‹', {
      count: migrations.length,
    });
    
    // 4. Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ (ĞµÑĞ»Ğ¸ Ğ±Ğ°Ğ·Ğ° Ğ¿ÑƒÑÑ‚Ğ°Ñ)
    const empty = await checkDbEmpty();
    if (empty) {
      logger.info('ğŸŒ± Ğ‘Ğ°Ğ·Ğ° Ğ¿ÑƒÑÑ‚Ğ°Ñ, Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸...');
      await seedUniversities();
      logger.info('âœ… Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹');
    } else {
      logger.info('ğŸ“Š Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑƒĞ¶Ğµ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ');
    }
    
    // 5. Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ„Ğ¾Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ°
    logger.info('âš™ï¸  Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ„Ğ¾Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ...');
    startUpdateWorker();
    
    // 6. Ğ—Ğ°Ğ¿ÑƒÑĞº Fresh ÑĞµÑ€Ğ²ĞµÑ€Ğ°
    const initDuration = Date.now() - startTime;
    logger.info('ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ²ĞµĞ±-ÑĞµÑ€Ğ²ĞµÑ€Ğ°...');
    logger.info(`âœ… Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ° Ğ·Ğ° ${initDuration}ms`);
    logger.info('');
    logger.info('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    logger.info(`â•‘  Ğ¡ĞµÑ€Ğ²ĞµÑ€: http://localhost:${env.PORT}            â•‘`);
    logger.info('â•‘  API:    /api/universities               â•‘');
    logger.info('â•‘  Health: /api/debug?action=health        â•‘');
    logger.info('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    logger.info('');
    
    // Ğ—Ğ°Ğ¿ÑƒÑĞº Fresh
    await start(manifest, config);
    
  } catch (err) {
    logger.error('âŒ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ:', err);
    throw err;
  }
}

/**
 * Graceful shutdown
 */
async function shutdown(): Promise<void> {
  logger.info('ğŸ›‘ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ ÑĞ¸Ğ³Ğ½Ğ°Ğ» Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ...');
  
  try {
    // ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ğ¾Ñ€ĞºĞµÑ€
    stopUpdateWorker();
    logger.info('âœ… Ğ’Ğ¾Ñ€ĞºĞµÑ€ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½');
    
    // Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿ÑƒĞ» Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¹
    await closePool();
    logger.info('âœ… ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº Ğ‘Ğ” Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹');
    
    logger.info('ğŸ‘‹ Ğ”Ğ¾ ÑĞ²Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ!');
  } catch (err) {
    logger.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğ¸:', err);
  }
}

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ
Deno.addSignalListener('SIGINT', async () => {
  await shutdown();
  Deno.exit(0);
});

Deno.addSignalListener('SIGTERM', async () => {
  await shutdown();
  Deno.exit(0);
});

// Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
main().catch((err) => {
  console.error('ğŸ’¥ Fatal error:', err);
  Deno.exit(1);
});
