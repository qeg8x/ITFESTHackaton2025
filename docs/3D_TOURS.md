# üé¨ 3D-–¢—É—Ä—ã —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–≤

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ 3D-—Ç—É—Ä–æ–≤ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ –ø–æ—Å–µ—Ç–∏—Ç—å –∫–∞–º–ø—É—Å—ã —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ –ø–∞–Ω–æ—Ä–∞–º—ã Google Street View, –Ø–Ω–¥–µ–∫—Å –ü–∞–Ω–æ—Ä–∞–º—ã –∏ 2GIS.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      Frontend                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Tour3DSection (Island)                                      ‚îÇ
‚îÇ  ‚îú‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç—É—Ä–∞                                    ‚îÇ
‚îÇ  ‚îú‚îÄ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (Google/Yandex/2GIS)            ‚îÇ
‚îÇ  ‚îî‚îÄ Iframe –ø–ª–µ–µ—Ä                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      API                                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  GET /api/universities/:id/3d-tour                           ‚îÇ
‚îÇ  ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞                                           ‚îÇ
‚îÇ  ‚îú‚îÄ –ó–∞–ø—Ä–æ—Å –≤ –ë–î                                             ‚îÇ
‚îÇ  ‚îî‚îÄ Fallback –ª–æ–≥–∏–∫–∞                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      Database                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  universities."3d_tour" (JSONB)                              ‚îÇ
‚îÇ  ‚îú‚îÄ google_maps                                              ‚îÇ
‚îÇ  ‚îú‚îÄ yandex_panorama                                          ‚îÇ
‚îÇ  ‚îú‚îÄ twogis                                                   ‚îÇ
‚îÇ  ‚îú‚îÄ primary_source                                           ‚îÇ
‚îÇ  ‚îî‚îÄ available_sources[]                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### UniversityThreeDTour (JSONB)

```typescript
interface UniversityThreeDTour {
  google_maps?: ThreeDTourSource;
  yandex_panorama?: ThreeDTourSource;
  twogis?: ThreeDTourSource;
  primary_source?: 'google' | 'yandex' | '2gis';
  available_sources: ('google' | 'yandex' | '2gis')[];
  last_updated?: Date;
}

interface ThreeDTourSource {
  source: 'google' | 'yandex' | '2gis';
  url: string;
  latitude: number;
  longitude: number;
  address?: string;
  available: boolean;
  last_validated: Date;
}
```

## API

### GET /api/universities/:id/3d-tour

–ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ 3D-—Ç—É—Ä–∞ –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞.

**–û—Ç–≤–µ—Ç:**
```json
{
  "id": "uuid",
  "name": "–ù–∞–∑–≤–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞",
  "available_sources": ["google", "yandex"],
  "primary_source": "google",
  "selected_source": {
    "source": "google",
    "data": {
      "url": "https://...",
      "latitude": 43.238,
      "longitude": 76.945
    }
  },
  "tour_data": {...},
  "fallback_chain": ["google", "yandex"],
  "last_updated": "2024-01-15T10:00:00Z"
}
```

## –°–µ—Ä–≤–∏—Å—ã

### TourService
–û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç—É—Ä–∞–º–∏.
- `getTourById(id)` - –ø–æ–ª—É—á–∏—Ç—å —Ç—É—Ä
- `updateTour(id, data)` - –æ–±–Ω–æ–≤–∏—Ç—å —Ç—É—Ä
- `checkTourAvailability(id)` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å

### TourSourceSelector
–í—ã–±–æ—Ä –ª—É—á—à–µ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Å fallback.
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: Google ‚Üí Yandex ‚Üí 2GIS
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏

### CacheManager
In-memory –∫—ç—à —Å TTL.
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 24 —á–∞—Å–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è

## –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—É—Ä–æ–≤

### –ó–∞–ø—É—Å–∫ batch-–æ–±—Ä–∞–±–æ—Ç–∫–∏

```bash
deno run --allow-all scripts/process-3d-tours.ts --limit=10
```

### –û–ø—Ü–∏–∏

| –û–ø—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|
| `--limit=N` | –õ–∏–º–∏—Ç —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 50) |
| `--no-ai` | –û—Ç–∫–ª—é—á–∏—Ç—å AI –∞–Ω–∞–ª–∏–∑ |
| `--include-existing` | –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Ç—É—Ä–∞–º–∏ |

### –ü—Ä–æ—Ü–µ—Å—Å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

1. –ó–∞–≥—Ä—É–∑–∫–∞ HTML —Å–∞–π—Ç–∞ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞
2. –ü–æ–∏—Å–∫ —Å—Å—ã–ª–æ–∫ –Ω–∞ –∫–∞—Ä—Ç—ã (regex)
3. AI –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ Ollama (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
4. –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Å—ã–ª–æ–∫
5. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
6. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î

## –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

```sql
-- sql/006_add_3d_tour.sql
ALTER TABLE universities
ADD COLUMN IF NOT EXISTS "3d_tour" JSONB DEFAULT NULL;

CREATE INDEX IF NOT EXISTS idx_3d_tour_available
ON universities USING GIN(("3d_tour"->'available_sources'));
```

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã UI

### Tour3DSection
Island-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞.
- –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–∞—è —Å–µ–∫—Ü–∏—è
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- Iframe –ø–ª–µ–µ—Ä —Å –∑–∞–≥—Ä—É–∑–∫–æ–π

### TourPlayer
–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö).

### TourButton
–ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ç—É—Ä–∞.

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
GOOGLE_MAPS_API_KEY=your_key
YANDEX_MAPS_API_KEY=your_key
TWOGIS_API_KEY=your_key

# –î–ª—è AI —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
OLLAMA_URL=http://localhost:11434
OLLAMA_MODEL=llama2
```

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

1. **Google Maps Street View** - –ª—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ, —à–∏—Ä–æ–∫–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
2. **–Ø–Ω–¥–µ–∫—Å –ü–∞–Ω–æ—Ä–∞–º—ã** - —Ö–æ—Ä–æ—à–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –≤ –°–ù–ì
3. **2GIS** - –æ—Ç–ª–∏—á–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ

## Troubleshooting

### –¢—É—Ä –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ë–î: `SELECT "3d_tour" FROM universities WHERE id = '...'`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API: `curl /api/universities/:id/3d-tour`

### Iframe –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç iframe (CORS)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É "–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ"

### Ollama –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
- –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ Ollama –∑–∞–ø—É—â–µ–Ω–∞: `ollama serve`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–¥–µ–ª—å: `ollama list`
