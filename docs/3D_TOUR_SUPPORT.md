# 3D-тур кампусов

## Назначение

Расширяет профиль университета структурой `3d_tour`, позволяя хранить ссылки на виртуальные туры из разных источников (Google Maps, Yandex Панорамы, 2GIS) и выбирать приоритетный источник с fallback-механизмом.

## JSON-структура профиля

Поле `3d_tour` добавлено в объект университета:

| Поле | Тип | Описание |
| --- | --- | --- |
| `google_maps` | `ThreeDTourSource?` | Данные тура Google (если доступны) |
| `yandex_panorama` | `ThreeDTourSource?` | Данные тура Яндекс |
| `twogis` | `ThreeDTourSource?` | Данные тура 2GIS |
| `primary_source` | `'google' \| 'yandex' \| '2gis'` | Источник, который следует использовать первым |
| `available_sources` | `ThreeDTourProvider[]` | Отсортированный список всех валидных источников (используется для fallback) |
| `last_updated` | `Date?` | Время последнего обновления блока |

`ThreeDTourSource` содержит:

| Поле | Тип | Описание |
| --- | --- | --- |
| `source` | `ThreeDTourProvider` | Название поставщика |
| `url` | `string` | HTTPS ссылка на тур |
| `latitude` | `number` | Широта источника |
| `longitude` | `number` | Долгота источника |
| `address` | `string?` | Адрес точки |
| `available` | `boolean` | Флаг доступности тура |
| `last_validated` | `Date` | Когда ссылка проверялась последним |

## Fallback-механизм

1. Парсер нормализует все источники и формирует список `available_sources` в порядке их обнаружения.
2. `primary_source` берётся из входных данных, если он есть в `available_sources`, иначе автоматически устанавливается первым валидным источником.
3. Клиентская логика должна использовать `primary_source` и переходить к следующему элементу из `available_sources`, если основной источник недоступен.

## Валидация

Добавлен `src/validators/3DTourValidator.ts`:

- проверка HTTPS-ссылок и соответствия домену поставщика;
- проверка координат (широта `[-90, 90]`, долгота `[-180, 180]`);
- проверка, что существует минимум один валидный источник;
- верификация `primary_source`, что он входит в `available_sources`.

## База данных

- В таблице `universities` добавлено поле `"3d_tour" JSONB` (миграция `sql/006_add_3d_tour.sql`).
- Создан GIN-индекс `idx_3d_tour_available` для ускорения фильтрации по массиву доступных источников.

## Типы TypeScript

Обновлён `src/types/university.ts`:

- добавлены типы `ThreeDTourProvider`, `ThreeDTourSource`, `UniversityThreeDTour`;
- интерфейс `University` получил опциональное поле `3d_tour`.

## Парсер

`validateAndNormalizeProfile` приводит структуру 3D-туров к нормализованному виду, ограничивает координаты допустимыми диапазонами и выставляет fallback-логику на уровне данных. Клиентам не требуется дополнительная обработка.
